<!DOCTYPE html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      position: absolute;
      margin: 0;
      width: 100%;
      height: 100%;
      user-select: none;
      -webkit-user-select: none;
      font: 8pt monospace;
    }
    .body-wrapper {
      box-sizing: border-box;
      display: flex;
      background-color: #eee;
      flex-direction: column;
      margin: 0 auto;
      max-width: 800px;
      width: 100%;
      height: 100%;
      padding: 10px;
    }
    .bborder {
      padding-bottom: 0.5em;
      margin-bottom: 0.5em;
      border-bottom: 1px solid #999;
    }
    .info-wrapper {
      flex: 1;
      overflow: auto;
    }
    .info table {
      table-layout: fixed;
      width: 100%;
    }
    .info table td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .track-wrapper {
      flex: 3;
      overflow: auto;
    }
    .track {
      width: 100%;
      height: 100%;
    }
    .track thead th {
      top: 0;
      position: sticky;
      background: #eee;
    }
    .cell {
      display: flex;
      flex-direction: row;
      white-space: nowrap;
      overflow: hidden;
    }
    .note { flex: 1; }
    .ins { flex: 1; }
    .fx { flex: 1; }
    .hl { background-color: #333; color: white; }
  </style>
</head>
<body>
  <div class="body-wrapper">
    <div class="controls-wrapper bborder">
      <div class="config">
        <button id="play">play</button>
        <table>
          <tr>
            <th>song</th>
            <td id="song"></td>
          </tr>
          <tr>
            <th>pattern</th>
            <td id="pattern">0</td>
          </tr>
        </table>
      </div>
    </div>
    <div class="info-wrapper bborder">
      <div class="info">
        <table></table>
      </div>
    </div>
    <div class="track-wrapper">
      <table class="track">
      </table>
    </div>
  </div>

  <script>
    const $ = document.querySelector.bind(document);
    const playEl = $('#play');
    const audio = new AudioContext;

    const AUDIO_FRAMES = 4096;
    const fontSize = 16;
    const numIns = 31;
    const numRows = 64;
    const numInsCols = 2;

    let dv, node;
    let numChannels;
    let started = false, playing = false;
    let pattern = 0, row = 0;
    const rowEls = [];

    let initialized = (async function() {
      module = await WebAssembly.compile(
            await (await fetch('mod.wasm')).arrayBuffer());

      await audio.audioWorklet.addModule('worklet.js');
      node = new AudioWorkletNode(audio, 'player', {
        numberOfInputs: 0,
        numberOfOutputs: 1,
        outputChannelCount: [2],
        processorOptions: {sampleRate: audio.sampleRate, module}
      });
      node.port.onmessage = e => {
        switch (e.data.msg) {
          case 'init': init(e.data.channels); break;
          case 'draw': draw(e.data.pattern, e.data.row); break;
        }
      };
    })();

    async function load(name) {
      let [_, response] = await Promise.all([initialized, await fetch(name)]);
      const file = await response.arrayBuffer();
      dv = new DataView(file);
      node.port.postMessage({msg: 'load', file});
    }

    const songs = [
      /*  0 */ '2a03fox-ida_first.mod',
      /*  1 */ 'adkd_-_absalon_junction.mod',
      /*  2 */ 'adkd_-_solitary_work.mod',
      /*  3 */ 'atariklang_4k.mod',
      /*  4 */ 'back_to_the_past.mod',
      /*  5 */ 'backwithavengeance!.mod',
      /*  6 */ 'bonefish_and_mygg_-_brofists.mod',
      /*  7 */ 'calcpreculation.mod',
      /*  8 */ 'clairvoy.mod',
      /*  9 */ 'comatron_-_d4wn.mod',
      /* 10 */ 'cream_of_the_earth.mod',
      /* 11 */ 'dascon_-_begrenzt_viruzid.mod',
      /* 12 */ 'eightbm_the_new_republic_cafe.mod',
      /* 13 */ 'eightbm_tove_janssons_groove.mod',
      /* 14 */ 'enigma.mod',
      /* 15 */ 'essai_sawwave_01v06.mod',
      /* 16 */ 'gouafhg_-_chucky_diagrom_anthem.mod',
      /* 17 */ 'GSLINGER.MOD',
      /* 18 */ 'josss_-_distortion.mod',
      /* 19 */ 'lazydayz.mod',
      /* 20 */ 'maze_-_virtual_disco_chip.mod',
      /* 21 */ 'moby_and_ra_-_bud_rap.mod',
      /* 22 */ 'robyn_and_dhr2_-_fashion_statement.mod',
      /* 23 */ 'seaoflov.mod',
      /* 24 */ 'space_debris.mod',
      /* 25 */ 'triace_-_12_bars_-_all_closed.mod',
      /* 26 */ 'virgill_and_slimey_-_the_codewizard.mod',
      /* 27 */ 'virgill_-_cherry_coke.mod',
    ];
    load(`mods/${songs[27]}`);

    playEl.addEventListener('click', _ => {
      // Wait to connect on user action.
      if (!started) {
        started = true;
        audio.resume();
        node.connect(audio.destination);
      }
      playing = !playing;
      node.port.postMessage({msg: 'play', value: playing});
      playEl.textContent = playing ? 'pause' : 'play';
    });

    function init(channels) {
      const decoder = new TextDecoder();
      function getString(offset, len) {
        const buf = new Uint8Array(dv.buffer, offset, len);
        return decoder.decode(buf).replace(/\0*$/, '');
      }

      numChannels = channels;

      document.querySelector('#song').textContent = getString(0, 20);
      const infoTableEl = document.querySelector('.info table');
      const numInsRows = Math.ceil(numIns / numInsCols);
      for (let row = 0; row < numInsRows; ++row) {
        const trEl = document.createElement('tr');
        for (let col = 0; col < numInsCols; ++col) {
          const ins = col * numInsRows + row;
          if (ins < numIns) {
            const comment = getString(0x14 + ins * 30, 22);
            const tdEl = document.createElement('td');
            tdEl.innerHTML = `<b>${ins}</b> ${comment}`;
            trEl.appendChild(tdEl);
          }
        }
        infoTableEl.appendChild(trEl);
      }

      const trackEl = document.querySelector('.track');
      {
        const theadEl = document.createElement('thead');
        let thEl = document.createElement('th');
        thEl.textContent = 'row';
        theadEl.appendChild(thEl);

        for (let ch = 0; ch < numChannels; ++ch) {
          const thEl = document.createElement('th');
          thEl.textContent = `ch${ch + 1}`;
          theadEl.appendChild(thEl);
        }
        trackEl.appendChild(theadEl);
      }

      {
        const tbodyEl = document.createElement('tbody');
        for (let row = 0; row < numRows; ++row) {
          const trEl = document.createElement('tr');
          const thEl = document.createElement('th');
          thEl.textContent = `${row}`;
          trEl.appendChild(thEl);
          trEl.classList.add(`row${row}`);

          const channelEls = [];
          for (let ch = 0; ch < numChannels; ++ch) {
            const tdEl = document.createElement('td');
            const divEl = document.createElement('div');
            divEl.classList.add('cell', `ch${ch}`, `row${row}`)

            const noteEl = document.createElement('div');
            noteEl.classList.add('note');
            noteEl.textContent = 'C-2';

            const insEl = document.createElement('div');
            insEl.classList.add('ins');
            insEl.textContent = '00';

            const fxEl = document.createElement('div');
            fxEl.classList.add('fx');
            fxEl.textContent = 'C20';

            divEl.appendChild(noteEl);
            divEl.appendChild(insEl);
            divEl.appendChild(fxEl);
            tdEl.appendChild(divEl);
            trEl.appendChild(tdEl);
            channelEls.push({div: divEl, note:noteEl, ins:insEl, fx:fxEl});
          }
          tbodyEl.appendChild(trEl);
          rowEls.push(channelEls);
        }
        trackEl.appendChild(tbodyEl);
      }
    }

    function draw(p, r) {
      newPattern(p);
      newRow(r);
    }

    const notes = {
      0:"",856:"C-1 ",808:"C#-1",762:"D-1 ",720:"D#-1",678:"E-1 ",640:"F-1 ",
      604:"F#-1",570:"G-1 ",538:"G#-1",508:"A-1 ",480:"A#-1",453:"B-1 ",
      428:"C-2 ",404:"C#-2",381:"D-2 ",360:"D#-2",339:"E-2 ",320:"F-2 ",
      302:"F#-2",285:"G-2 ",269:"G#-2",254:"A-2 ",240:"A#-2",226:"B-2 ",
      214:"C-3 ",202:"C#-3",190:"D-3 ",180:"D#-3",170:"E-3 ",160:"F-3 ",
      151:"F#-3",143:"G-3 ",135:"G#-3",127:"A-3 ",120:"A#-3",113:"B-3 ",
    };
    const hex = x => x.toString(16).toUpperCase();
    const hex2 = x => hex(x).padStart(2, '0');
    function newPattern(p) {
      document.querySelector('#pattern').textContent = p;
      pattern = p;
      let offset = 0x43c + (dv.getUint8(0x3b8 + p) * 64) * numChannels * 4;
      for (let row = 0; row < numRows; ++row) {
        for (let ch = 0; ch < numChannels; ++ch) {
          const key = ((dv.getUint8(offset) & 0xf) << 8) | dv.getUint8(offset + 1);
          const ins = (dv.getUint8(offset + 2) >> 4) | dv.getUint8(offset) & 0x10;
          const effect = dv.getUint8(offset + 2) & 0xf;
          const param = dv.getUint8(offset + 3);

          const el = rowEls[row][ch];
          const noteEl = el.note;
          const insEl = el.ins;
          const fxEl = el.fx;

          noteEl.textContent = notes[key];
          insEl.textContent = ins ? hex2(ins) : '-';
          fxEl.textContent = effect ? `${hex(effect)}${hex2(param)}` : '---';

          offset += 4;
        }
      }
    }

    function newRow(r) {
      for (let ch = 0; ch < numChannels; ++ch) {
        rowEls[row][ch].div.classList.remove('hl');
        rowEls[r][ch].div.classList.add('hl');
      }
      row = r;
      rowEls[r][0].div.scrollIntoView({
        block: 'center',
      })
    }
  </script>
</body>
